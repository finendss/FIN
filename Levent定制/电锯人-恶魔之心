local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
	Name = "定制-电锯人[恶魔之心]",
	LoadingTitle = "感谢定制",
	LoadingSubtitle = "By 鑫晴",
	Theme = "Default",
	ToggleUIKeybind = Enum.KeyCode.K,
	KeySystem = false
})

local FarmTab = Window:CreateTab("自动刷怪", "Swords")
local PlayerTab = Window:CreateTab("玩家", "User")
local ESPTab = Window:CreateTab("透视", "Eye")
local HalloweenTab = Window:CreateTab("万圣节", "Ghost")

local function notify(title, content)
	Rayfield:Notify({
		Title = title,
		Content = content,
		Duration = 3
	})
end

local function touchPart(part)
	if part and part:IsA("BasePart") and Player and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
		pcall(function()
			firetouchinterest(Player.Character.HumanoidRootPart, part, 0)
			task.wait(0.05)
			firetouchinterest(Player.Character.HumanoidRootPart, part, 1)
		end)
	end
end

local autofarmRunning = false
local autofarmThread
local lastEquipTime = 0

local function getCharacter()
	while not Player.Character or not Player.Character:FindFirstChild("HumanoidRootPart") do
		Player.CharacterAdded:Wait()
		task.wait()
	end
	return Player.Character
end

local function equipKatana()
	if tick() - lastEquipTime < 3 then return end
	lastEquipTime = tick()

	local char = getCharacter()
	local backpack = Player:FindFirstChild("Backpack")
	if backpack then
		local katana = backpack:FindFirstChild("Katana") or char:FindFirstChild("Katana")
		if katana and not char:FindFirstChild("Katana") then
			char.Humanoid:EquipTool(katana)
		end
	end
end

local function closestFiend()
	local npcs = Workspace:FindFirstChild("Living")
	local closest, minDist = nil, math.huge
	if npcs then
		for _, npc in pairs(npcs:GetChildren()) do
			if npc.Name:lower():find("fiend") and npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 then
				local char = getCharacter()
				local hrp = char and char:FindFirstChild("HumanoidRootPart")
				if hrp then
					local dist = (hrp.Position - npc.HumanoidRootPart.Position).Magnitude
					if dist < minDist then
						closest = npc
						minDist = dist
					end
				end
			end
		end
	end
	return closest
end

local function orbitAndAttack(npc)
	local char = getCharacter()
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	local npcHRP = npc and npc:FindFirstChild("HumanoidRootPart")
	if not hrp or not npcHRP then return end

	local orbitSpeed = 6
	local orbitRadius = 7

	local conn
	conn = RunService.RenderStepped:Connect(function()
		if not autofarmRunning or not npc or not npc.Parent or not npc.Humanoid or npc.Humanoid.Health <= 0 then
			if conn then conn:Disconnect() end
			return
		end

		equipKatana()
		local angle = tick() * orbitSpeed
		local offset = Vector3.new(math.cos(angle) * orbitRadius, 0, math.sin(angle) * orbitRadius)
		local targetPos = npcHRP.Position + offset
		hrp.CFrame = hrp.CFrame:Lerp(CFrame.new(targetPos, npcHRP.Position), 0.4)

		if ReplicatedStorage:FindFirstChild("events") and ReplicatedStorage.events:FindFirstChild("remote") then
			ReplicatedStorage.events.remote:FireServer("NormalAttack")
		end
	end)
end

FarmTab:CreateButton({
	Name = "自动刷怪",
	Callback = function()
		autofarmRunning = not autofarmRunning
		notify("自动刷怪", autofarmRunning and "✅ 已启用" or "❌ 已禁用")

		if autofarmRunning then
			autofarmThread = task.spawn(function()
				local quest_boy = Workspace:WaitForChild("DialogNPCs"):WaitForChild("grown up boy"):WaitForChild("HumanoidRootPart")

				while autofarmRunning do
					local char = getCharacter()
					local hrp = char and char:FindFirstChild("HumanoidRootPart")

					if not hrp then
						task.wait(0.1)
						continue
					end

					local questGui = Player:FindFirstChild("PlayerGui") and Player.PlayerGui:FindFirstChild("Quest")
					local questActive = false
					if questGui and questGui:FindFirstChild("quest") and questGui:FindFirstChild("progress") then
						local quest = questGui.quest
						local progress = questGui.progress
						if tostring(quest.Value):lower():find("fiends") and tonumber(progress.Value) < tonumber((questGui.max and questGui.max.Value) or 3) then
							questActive = true
						end
					end

					if not questActive then
						if hrp then
							local dist = (hrp.Position - quest_boy.Position).Magnitude
							if dist > 8 then
								hrp.CFrame = CFrame.new(quest_boy.Position + Vector3.new(0, 0, -2), quest_boy.Position)
							else
								local prompt = quest_boy.Parent:FindFirstChildOfClass("ProximityPrompt")
								if prompt then pcall(fireproximityprompt, prompt) end
							end
						end
					else
						local npc = closestFiend()
						if npc then
							orbitAndAttack(npc)
							repeat task.wait(0.1) until not npc or not npc.Parent or not npc:FindFirstChild("Humanoid") or npc.Humanoid.Health <= 0 or not autofarmRunning
						else
							task.wait(0.5)
						end
					end

					task.wait(0.3)
				end
			end)
		else
			if autofarmThread then
				task.cancel(autofarmThread)
				autofarmThread = nil
			end
		end
	end
})

local questOn = false
FarmTab:CreateButton({
	Name = "自动完成任务",
	Callback = function()
		questOn = not questOn
		notify("自动完成任务", questOn and "✅ 已启用" or "❌ 已禁用")

		if questOn then
			task.spawn(function()
				while questOn do
					task.wait(0.2)
					local interactable = Workspace:FindFirstChild("Interactable")
					if not interactable then
						task.wait(0.2)
					else
						local goals = interactable:FindFirstChild("pizzagoals")
						local couch = interactable:FindFirstChild("CouchGoal")

						if goals then
							for _, part in ipairs(goals:GetDescendants()) do
								if not questOn then break end
								if part:IsA("BasePart") then
									touchPart(part)
									task.wait(0.1)
								end
							end
						end

						if couch and couch:IsA("BasePart") then
							touchPart(couch)
							task.wait(0.2)
						end
					end
				end
			end)
		end
	end
})

local noclipEnabled = false
local noclipConnection
local jitter = 0.05

PlayerTab:CreateButton({
	Name = "穿墙模式 (绕过安全检测)",
	Callback = function()
		noclipEnabled = not noclipEnabled
		notify("穿墙模式", noclipEnabled and "✅ 已启用 (绕过激活)" or "❌ 已禁用")

		if noclipEnabled then
			local jitterSeed = math.random(1, 9999)
			noclipConnection = RunService.Stepped:Connect(function()
				pcall(function()
					local char = Player.Character
					local hrp = char and char:FindFirstChild("HumanoidRootPart")
					if not char or not hrp then return end

					for _, v in pairs(char:GetDescendants()) do
						if v:IsA("BasePart") then
							v.CanCollide = false
						end
					end

					local offset = Vector3.new(
						math.sin(tick() * 10 + jitterSeed) * jitter,
						0,
						math.cos(tick() * 10 + jitterSeed) * jitter
					)
					hrp.CFrame = hrp.CFrame + offset
				end)
			end)
		elseif noclipConnection then
			noclipConnection:Disconnect()
			noclipConnection = nil
		end
	end
})

local flying = false
PlayerTab:CreateButton({
	Name = "飞行平台",
	Callback = function()
		flying = not flying
		notify("飞行平台", flying and "✅ 已启用" or "❌ 已禁用")

		if flying then
			local char = Player.Character or Player.CharacterAdded:Wait()
			local hrp = char:WaitForChild("HumanoidRootPart")
			local p = Instance.new("Part")
			p.Size = Vector3.new(8, 1, 8)
			p.Anchored = true
			p.Transparency = 0.5
			p.Color = Color3.fromRGB(0, 255, 100)
			p.Material = Enum.Material.Neon
			p.Parent = Workspace

			local conn
			conn = RunService.RenderStepped:Connect(function()
				if not flying or not p or not p.Parent then
					conn:Disconnect()
					if p then p:Destroy() end
					return
				end
				p.CFrame = CFrame.new(hrp.Position.X, hrp.Position.Y - 4, hrp.Position.Z)
			end)
		end
	end
})

local devilEspEnabled = false
local devilEspParts = {}
local targetMeshId = "rbxassetid://12439777368"
local heartDetected = false

local rayParams = RaycastParams.new()
rayParams.FilterType = Enum.RaycastFilterType.Blacklist
rayParams.IgnoreWater = true

local NUM_RAYS = 250
local OFFSET_RADIUS = 10000
local MAP_CENTER = Vector3.new(0, 0, 0)

local function randomSphereOffset(radius)
	local u = math.random()
	local v = math.random()
	local theta = 2 * math.pi * u
	local phi = math.acos(2 * v - 1)
	local x = radius * math.sin(phi) * math.cos(theta)
	local y = radius * math.sin(phi) * math.sin(theta)
	local z = radius * math.cos(phi)
	return Vector3.new(x, y, z)
end

ESPTab:CreateButton({
	Name = "恶魔之心透视",
	Callback = function()
		devilEspEnabled = not devilEspEnabled
		notify("恶魔之心透视", devilEspEnabled and "✅ 已启用" or "❌ 已禁用")

		if devilEspEnabled then
			task.spawn(function()
				while devilEspEnabled do
					for _, p in ipairs(devilEspParts) do if p and p.Parent then p:Destroy() end end
					table.clear(devilEspParts)

					local char = Player.Character
					if not char or not char:FindFirstChild("HumanoidRootPart") then
						task.wait(1)
					else
						for _, obj in ipairs(Workspace:GetDescendants()) do
							if obj:IsA("MeshPart") and obj.MeshId == targetMeshId then
								if obj.Position.Y < -5 then
								else
									local visible = true

									if visible then
										if not heartDetected then
											heartDetected = true
											notify("💥 检测到恶魔之心!", "附近生成了恶魔之心!")
										end

										local highlight = Instance.new("Highlight")
										highlight.FillColor = Color3.fromRGB(255, 0, 0)
										highlight.OutlineColor = Color3.fromRGB(255, 100, 100)
										highlight.Adornee = obj
										highlight.Parent = obj
										table.insert(devilEspParts, highlight)

										local billboard = Instance.new("BillboardGui")
										billboard.Adornee = obj
										billboard.Size = UDim2.new(0, 120, 0, 35)
										billboard.AlwaysOnTop = true
										billboard.StudsOffset = Vector3.new(0, 5, 0)
										billboard.Parent = obj

										local text = Instance.new("TextLabel")
										text.Size = UDim2.new(1, 0, 1, 0)
										text.BackgroundTransparency = 1
										text.TextColor3 = Color3.fromRGB(0, 255, 100)
										text.TextStrokeTransparency = 0
										text.TextScaled = true
										text.Font = Enum.Font.Code
										text.Text = "0米"
										text.Parent = billboard

										local conn
										conn = RunService.RenderStepped:Connect(function()
											if not devilEspEnabled or not obj or not obj.Parent or not char or not char.Parent then
												conn:Disconnect()
												if billboard then billboard:Destroy() end
												return
											end
											local dist = math.floor((obj.Position - char.HumanoidRootPart.Position).Magnitude)
											text.Text = tostring(dist) .. "米"
										end)
									end
								end
							end
						end
					end

					task.wait(2)
				end

				for _, p in ipairs(devilEspParts) do if p and p.Parent then p:Destroy() end end
				table.clear(devilEspParts)
				heartDetected = false
			end)
		else
			for _, p in ipairs(devilEspParts) do if p and p.Parent then p:Destroy() end end
			table.clear(devilEspParts)
			heartDetected = false
		end
	end
})

local playerEspEnabled = false
local playerEspObjects = {}

ESPTab:CreateButton({
	Name = "玩家透视",
	Callback = function()
		playerEspEnabled = not playerEspEnabled
		notify("玩家透视", playerEspEnabled and "✅ 已启用" or "❌ 已禁用")

		if playerEspEnabled then
			task.spawn(function()
				while playerEspEnabled do
					for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
					table.clear(playerEspObjects)

					for _, plr in ipairs(Players:GetPlayers()) do
						if plr ~= Player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
							local highlight = Instance.new("Highlight")
							highlight.FillColor = Color3.fromRGB(0, 255, 100)
							highlight.OutlineColor = Color3.fromRGB(0, 255, 100)
							highlight.Adornee = plr.Character
							highlight.Parent = plr.Character
							table.insert(playerEspObjects, highlight)
						end
					end

					task.wait(1)
				end

				for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
				table.clear(playerEspObjects)
			end)
		else
			for _, obj in ipairs(playerEspObjects) do if obj and obj.Parent then obj:Destroy() end end
			table.clear(playerEspObjects)
		end
	end
})

local specterFarmRunning = false
local specterFarmThread
lastEquipTime = 0

HalloweenTab:CreateButton({
	Name = "自动刷灵魂 (仅在夜晚有效)",
	Callback = function()
		specterFarmRunning = not specterFarmRunning

		if specterFarmRunning then
			notify("万圣节活动", "自动刷幽灵已启用 👻")

			specterFarmThread = task.spawn(function()
				local function getCharacter()
					while not Player.Character or not Player.Character:FindFirstChild("HumanoidRootPart") do
						Player.CharacterAdded:Wait()
						task.wait(0.2)
					end
					return Player.Character
				end

				local function equipKatanaLocal()
					if tick() - lastEquipTime < 3 then return end
					lastEquipTime = tick()

					local char = getCharacter()
					local backpack = Player:FindFirstChild("Backpack")
					if backpack then
						local katana = backpack:FindFirstChild("Katana") or char:FindFirstChild("Katana")
						if katana and not char:FindFirstChild("Katana") then
							char.Humanoid:EquipTool(katana)
						end
					end
				end

				local function closest_specter()
					local living = Workspace:FindFirstChild("Living")
					local closest, minDist = nil, math.huge
					if living then
						for _, npc in pairs(living:GetChildren()) do
							if npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Humanoid") then
								local name = npc.Name:lower()
								if name:match("^specter%d*$") and npc.Humanoid.Health > 0 then
									local char = getCharacter()
									local hrp = char and char:FindFirstChild("HumanoidRootPart")
									if hrp then
										local dist = (hrp.Position - npc.HumanoidRootPart.Position).Magnitude
										if dist < minDist then
											minDist = dist
											closest = npc
										end
									end
								end
							end
						end
					end
					return closest
				end

				local function attack_specter(npc)
					local char = getCharacter()
					local hrp = char and char:FindFirstChild("HumanoidRootPart")
					local npcHRP = npc and npc:FindFirstChild("HumanoidRootPart")
					if not hrp or not npcHRP then return end

					local orbitSpeed = 6
					local orbitRadius = 8

					local orbitConn
					orbitConn = RunService.RenderStepped:Connect(function()
						if not specterFarmRunning or not npc or not npc.Parent or not npc.Humanoid or npc.Humanoid.Health <= 0 then
							if orbitConn then orbitConn:Disconnect() end
							return
						end

						equipKatanaLocal()

						local angle = tick() * orbitSpeed
						local offset = Vector3.new(math.cos(angle) * orbitRadius, 0, math.sin(angle) * orbitRadius)
						local targetPos = npcHRP.Position + offset
						hrp.CFrame = hrp.CFrame:Lerp(CFrame.new(targetPos, npcHRP.Position), 0.4)

						if ReplicatedStorage:FindFirstChild("events") and ReplicatedStorage.events:FindFirstChild("remote") then
							ReplicatedStorage.events.remote:FireServer("NormalAttack")
						end
					end)
				end

				while specterFarmRunning do
					local npc = closest_specter()
					if npc then
						local char = getCharacter()
						local hrp = char and char:FindFirstChild("HumanoidRootPart")
						if not hrp then
							task.wait(0.2)
						else
							local dist = (hrp.Position - npc.HumanoidRootPart.Position).Magnitude
							if dist > 35 then
								char:MoveTo(npc.HumanoidRootPart.Position)
								repeat task.wait() until (hrp.Position - npc.HumanoidRootPart.Position).Magnitude <= 35 or not npc.Parent
							end

							if npc and npc:FindFirstChild("Humanoid") and npc.Humanoid.Health > 0 then
								attack_specter(npc)
								repeat task.wait(0.1) until not npc or not npc.Parent or not npc:FindFirstChild("Humanoid") or npc.Humanoid.Health <= 0 or not specterFarmRunning
							end
						end
					else
						task.wait(1)
					end
				end
			end)
		else
			notify("万圣节活动", "自动刷幽灵已禁用 ❌")
			if specterFarmThread then
				task.cancel(specterFarmThread)
				specterFarmThread = nil
			end
		end
	end
})

local instantKillEnabled = false
local activeTexts = {}

PlayerTab:CreateButton({
	Name = "秒杀 + 伤害显示",
	Callback = function()
		instantKillEnabled = not instantKillEnabled
		notify("秒杀 + 伤害显示", instantKillEnabled and "✅ 已启用" or "❌ 已禁用")

		if not instantKillEnabled then
			for _, gui in pairs(activeTexts) do
				if gui and gui.Parent then gui:Destroy() end
			end
			table.clear(activeTexts)
			return
		end

		task.spawn(function()
			while instantKillEnabled do
				local living = Workspace:FindFirstChild("Living")
				if living then
					for _, npc in pairs(living:GetChildren()) do
						local humanoid = npc:FindFirstChildOfClass("Humanoid")
						local hrp = npc:FindFirstChild("HumanoidRootPart")
						local isPlayer = Players:FindFirstChild(npc.Name)

						if humanoid and hrp and not isPlayer and humanoid.Health > 0 then
							local maxHealth = humanoid.MaxHealth
							local currentHealth = humanoid.Health
							local damageRatio = 1 - (currentHealth / maxHealth)

							if currentHealth <= (maxHealth * 0.85) then
								humanoid.Health = 0
							end

							if not activeTexts[npc] then
								local gui = Instance.new("BillboardGui")
								gui.Adornee = hrp
								gui.Size = UDim2.new(4, 0, 1, 0)
								gui.StudsOffset = Vector3.new(0, 5, 0)
								gui.AlwaysOnTop = true
								gui.BackgroundTransparency = 1
								gui.Parent = npc

								local text = Instance.new("TextLabel", gui)
								text.Size = UDim2.new(1, 0, 1, 0)
								text.BackgroundTransparency = 1
								text.TextScaled = true
								text.Font = Enum.Font.GothamBold
								text.TextStrokeTransparency = 0.2
								text.Text = "0%"
								text.TextColor3 = Color3.fromRGB(0, 255, 100)

								activeTexts[npc] = gui

								task.spawn(function()
									while instantKillEnabled and humanoid and humanoid.Health > 0 do
										local dmgRatio = math.clamp(1 - (humanoid.Health / humanoid.MaxHealth), 0, 1)
										local percent = math.floor(dmgRatio * 100)

										local r = math.clamp(dmgRatio * 2, 0, 1)
										local g = math.clamp(2 - dmgRatio * 2, 0, 1)
										local color = Color3.new(r, g, 0)

										text.TextColor3 = color
										text.Text = tostring(percent) .. "%"

										task.wait(0.1)
									end

									if gui then gui:Destroy() end
									activeTexts[npc] = nil
								end)
							end
						end
					end
				end
				task.wait(1)
			end
		end)
	end
})
